name: Deploy Omnixys Service

on:
  workflow_run:
    workflows: ['Docker Build & Push ‚Äì Omnixys']
    types: [completed]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: [self-hosted, omnixys-prod]
    concurrency:
      group: omnixys-prod
      cancel-in-progress: false
    env:
      SERVICE: ${{ vars.SERVICE }}

    steps:
      - name: üîë Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Deploy ${{ vars.SERVICE }}
        shell: bash
        run: |
          set -euo pipefail
          cd /opt/omnixys/compose/app/backend

          echo "üöÄ Deploying service: $SERVICE"
          docker pull "omnixys/${SERVICE}-service"
          docker image prune -f
          docker compose up -d --no-deps "$SERVICE"

          echo "‚è≥ Waiting for health..."
          CID=$(docker compose ps -q "$SERVICE")
          if [ -z "$CID" ]; then
            echo "‚ùå No container for service $SERVICE"
            exit 1
          fi

          for i in {1..30}; do
            STATUS=$(docker inspect --format='{{if .State.Health}}{{.State.Health.Status}}{{else}}no-healthcheck{{end}}' "$CID")
            if [ "$STATUS" = "healthy" ] || [ "$STATUS" = "no-healthcheck" ]; then
              echo "‚úÖ $SERVICE is ok ($STATUS)"
              exit 0
            fi
            sleep 2
          done

          echo "‚ùå $SERVICE did not become healthy"
          exit 1
