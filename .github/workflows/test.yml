# @license GPL-3.0-or-later
# Copyright (C) 2025 Caleb Gyamfi - Omnixys Technologies
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# See the GNU General Public License for more details.
#
# For more information, visit <https://www.gnu.org/licenses/>.

name: 🧪 E2E Authentication Tests

on:
  push:
    branches: [main, dev]
  # pull_request:
  #   branches: [main, dev]
  workflow_dispatch:


jobs:
  e2e:
    name: Run Auth E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 25

    services:
      postgres:
        image: postgres:18
        env:
          POSTGRES_USER: auth
          POSTGRES_PASSWORD: auth
          POSTGRES_DB: authdb
        ports:
          - 5433:5432
        options: >-
          --health-cmd "pg_isready -U auth"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 10

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 10

      zookeeper:
        image: wurstmeister/zookeeper
        ports:
          - 2181:2181
        env:
          ALLOW_ANONYMOUS_LOGIN: yes
        options: >-
          --health-cmd="echo ruok | nc localhost 2181 | grep imok"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=10

      kafka:
       image: wurstmeister/kafka
       env:
         KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
         KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
         KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
         KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
       ports:
         - 9092:9092
       options: >-
         --hostname kafka
         --health-cmd "bash -c 'nc -z localhost 9092 || exit 1'"
         --health-interval 10s
         --health-timeout 5s
         --health-retries 15
         --health-start-period 20s

      # keycloak:
      #   image: quay.io/keycloak/keycloak:25.0
      #   ports:
      #     - 18080:8080
      #   env:
      #     KEYCLOAK_ADMIN: admin
      #     KEYCLOAK_ADMIN_PASSWORD: admin
      #   options: >-
      #     --health-cmd "curl -f http://localhost:8080/auth/ || exit 1"
      #     --health-interval 10s
      #     --health-timeout 5s
      #     --health-retries 20
      #   volumes:
      #     - ${{ github.workspace }}/__tests__/keycloak/realm-config.json:/opt/keycloak/data/import/realm-config.json:ro

    steps:
      - name: 🛎️ Checkout repository
        uses: actions/checkout@v4

      - name: ⚙️ Enable Corepack (pnpm)
        run: |
          corepack enable
          corepack prepare pnpm@latest --activate

      - name: ⚙️ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24.10.0
          cache: 'pnpm'

      - name: 📦 Install dependencies
        run: |
          corepack enable
          pnpm install --frozen-lockfile

      - name: 🕐 Wait for services to be ready
        run: |
          echo "⏳ Waiting for services..."
          for i in {1..40}; do
            nc -z localhost 5433 && \
            nc -z localhost 6379 && \
            # nc -z localhost 2181 && \
            nc -z localhost 9092 && \
            curl -s http://localhost:18080/auth/ > /dev/null && \
            echo "✅ All services are healthy" && break
            echo "Services not ready yet ($i/40)..."
            sleep 5
          done

      - name: 🧪 Run E2E Auth Tests
        env:
          NODE_ENV: test
          DATABASE_URL: postgres://auth:auth@localhost:5433/authdb
          REDIS_URL: redis://localhost:6379
          KAFKA_BROKER: localhost:9092
          KC_URL: http://localhost:18080/auth
          KC_REALM: camunda-platform
          KC_CLIENT_ID: camunda-identity
          KC_CLIENT_SECRET: dummy
          KEYCLOAK_ADMIN_USERNAME: admin
          KEYCLOAK_ADMIN_PASSWORD: admin
          TEST_EMAIL_DOMAIN: omnixys.com
        run: |
          echo "🔧 Loading CI environment variables"
          export $(grep -v '^#' __tests__/.env.ci | xargs)
          pnpm run build
          # pnpm run test:e2e:auth
